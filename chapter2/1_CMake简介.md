# CMake简介

CMake是一个跨平台开源工具家族，用于构建、测试和打包软件。CMake通过简单的平台无关且编译器无关的配置文件来控制软件的编译流程，并能够生成原生的Makefile和工作空间，以便用于用户所选择的编译环境。

- 狭义的CMake一般特指用于构建项目的CMake工具及其使用的CMake脚本语言
- 广义的CMake指的是一系列工具的组合，包括用于构建的狭义的CMake、用于测试的CTest、用于打包的CPack等，它们都属于CMake家族。

本书的主要内容仅涉及狭义的CMake。

平台无关且编译器无关的配置文件, 指的是类似Makefile的配置文件。但CMake的配置文件是平台无关且编译器无关的，能够做到一次编写，到处编译。

能够生成原生的Makefile和工作空间，是在说CMake本身并不实际调用编译器和链接器等，而是根据配置生成Makefile或者其他构建工具的配置文件，通过它们来实际调用各种命令完成构建。
工作空间指与IDE相关的构建工具的配置，如Visual Studio中基于MSBuild的解决方案和项目工程文件，以及Xcode、CodeBlocks等其他IDE的项目工程文件。可见，将CMake称为构建工具不够准确，它更像是一个“元构建工具”，或者说是“构建工具的构建工具”。毕竟，它自己不会构建程序，而是指导其他构建工具来构建程序。这样的好处也很明显，就是“以便用于用户所选择的编译环境”。即便IDE不支持打开使用CMake 组织的项目，但总可以打开通过CMake生成的IDE原生项目。

## 1. CMake的优势

- 高效：
  - 帮助开发者把更多的时间花在编写代码上，而不是在配置和编译上。
  - CMake是开源的，可以自由用于任何项目
- 强大：
  - 支持在同一项目中使用多种开发环境和编译器
  - CMake支持多种编程语言，如C、C++、CUDA、Fortran、Python等，还支持在构建过程中执行任意的自定义命令
  - 支持持续集成，通过CTest可在Jenkins、Travis、CircleCI、GitlabCI等几乎任意持续集成系统中完成测试。测试结果可以在CDash中展示
  - 支持将第三方库集成到个人项目中
- CMake是研发团队的首选
  - CMake几乎已经成为构建C和C++项目的业界标准工具
  - 很多C++项目都开始使用CMake构建。根据2018 Octoverse报告，CMake脚本语言在GitHub上的增长速度排在第六位
  - CMake成熟且经过良好测试，拥有广泛的开发者社区

另外，CMake在很多方面都与C++语言很类似：
* 具有庞大的用户群体；
* 稳定地向后兼容；
* 强大的功能特性，支持多范式，较为复杂。

### 1.1 平台无关和编译器无关

向别人推荐CMake时，总会有人问，为什么不用Makefile或者Autoconf等工具。

编译器不同，很多命令参数也不同。Makefile和Autoconf对命令参数的抽象几乎不存在，这就导致一份Makefile或Autoconf配置文件常常只能用于命令参数所兼容的编译器。当不仅需要跨编译器，还需要跨操作系统时，这个弊端就更为凸显了。首先，GCC和MSVC的编译参数差距很大；其次，如果构建配置中还涉及调用其他一些命令，也很难保证这些命令在各个操作系统平台中是通用的。

使用一个平台无关和编译器无关的构建工具对于构建跨平台程序而言至关重要，CMake当然在此列。除此之外，CMake还支持交叉编译，可以满足更多样的构建需求。

### 1.2 开源自由而优秀的社区生态

若想一个产品被广泛接纳，将其开源作为自由软件是一个很好的办法。谁都不希望支撑着自己成千上万行程序代码的构建工具突然某一天就停止支持了。而开源意味着项目在理论上获得“永生”，最不济也可以自己接盘维护嘛！另外，CMake作为自由软件没有对商业用途设限，这进一步促进了来自社区的青睐。

一旦产品被社区广泛采纳，就意味着它的生态建立起来了。当有一个定制需求时，社区中很可能有人已经通过CMake实现了它，那么又有什么理由不直接用它呢？更重要的是，很多第三方库已经在使用CMake来构建它，若想在自己的程序中使用它们，同样使用CMake自然是最方便的。

另外，现在也有很多C和C++包管理工具支持CMake，甚至直接使用CMake来管理包的构建和安装流程。如果使用CMake，这些包管理工具所支持的第三方软件包基本上能够做到一键安装，这又何乐而不为呢？

最后，开源社区的共同维护能够提高软件缺陷的发现和修复速度，提高整个工具的鲁棒性。这对于CMake 这类构建流程中的核心基础设施尤为重要。

### 1.3 强大通用的脚本语言

CMake的脚本语言经常因为其古板的语法被人诟病，但其功能的强大是毋庸置疑的。它的脚本语言可以对标Shell脚本，提供了很多方便操作字符串、文件等的命令。同时，CMake脚本语言是领域特定语言（Domain Specific Language，DSL），即专注于某个应用程序领域的计算机语言。对于CMake来说，它所专注的便是构建这个领域，自然也提供了很多用于构建过程的命令，如下载并构建外部的项目、生成配置文件等。

CMake脚本语言既然是能够对标Shell脚本的图灵完备的语言，当然不仅限于描述构建过程。也可以用于编写测试脚本，甚至编写持续集成的整个流程。

### 1.4 稳定地向后兼容

CMake相当重视向后兼容。毕竟，使用C和C++构建的项目往往偏底层，会存在并被使用很长时间。经过漫长的时间，可能早已无人更新维护它了。因此，必须保证数年前的代码在今天依然能够被正常构建。在这一点上，CMake与C和C++很相似。

CMake提出了策略机制以保证稳定的向后兼容。一方面，保证原有配置的可用性；另一方面，为过时的配置提出警告和建议。这极大地方便了对古老的代码库遗产的维护和升级。

### 1.5 持续不断地改进和推出新特性

得益于CMake的策略机制，CMake可以在提供相当稳定的兼容性的前提下不断更新。 CMake也确实在持续不断地改进中。

实际上，CMake曾有很多不便之处，CMake 3.0版本的推出改善了这一缺陷。因此人们也常把此后版本的CMake称为“现代CMake”。CMake 2时代采用过程式脚本程序描述构建过程，封装性较差，很难厘清项目结构。而现代CMake为开发者提供了面向构建目标的构建配置，很多构建要求或使用要求通过绑定在构建目标上的属性来实现。这一改变为项目各组件的解耦提供了极大的便利。

## 2. 安装CMake

针对“Linux x86_x64”平台，也有两个安装文件可供下载：
- sh自解压脚本；
- tar.gz压缩包，用户可以自行解压到任意目录并配置环境变量等。
- apt install cmake